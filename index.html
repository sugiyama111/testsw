<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="manifest" href="/manifest.json" />
<script>
//const channel = new MessageChannel();
const iframe = document.querySelector('iframe'); // TWAをホストするiframe
const channel = new MessageChannel(); // 新しいメッセージチャネルを作成

// TWAにチャネルを送信
iframe.contentWindow.postMessage("Hello from PWA!", "*", [channel.port1]);
// メッセージを受信するためのリスナー
channel.port2.onmessage = (event) => {
    console.log("Received from TWA:", event.data);
};

function cl() {
	let d = new Date();
	document.getElementById('time').innerHTML = d;
	//window.postMessage("test from html");
	window.postMessage("test from html", "*", [channel.port1]);
	
}


let messagePort;

window.addEventListener("message", (event) => {
	
	
//console.log("Message received in PWA:", event.data);

	// メッセージのオリジンを確認
	if (event.origin !== "https://testsw.vercel.app") {
		console.warn("Untrusted origin:", event.origin);
		return;
	}
	// if (event.source === window) {
	// 	Toast.Info('do nothing because message is from PWA')
	// 	return;
	// }
	console.log(event.ports);
	console.log(event);
	
	messagePort = event.ports[0];
	console.log('port is : '+ messagePort);
	if (typeof messagePort === 'undefined') return;

	// Post message on this port.
	messagePort.postMessage("Test")

	// Receive upcoming messages on this port.
	messagePort.onmessage = function(event) {
		document.getElementById('msg').innerHTML = event.data;
		console.log("[PostMessage1] Got message" + event.data);
	};
});


</script>


</head>
<body>

<input type="button" value="押す" onclick="cl()" style="width:200px; height:150px; font-size:x-large;" />

<div style="background:#EEE;" id="time"></div>

<div style="background:#FDD;" id="msg"></div>
<iframe width="100" height="100" />

</body>
</html>
